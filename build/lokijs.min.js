!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.loki=factory()}(this,(function(){return function(){"use strict";var hasOwnProperty=Object.prototype.hasOwnProperty;function deepFreeze(obj){var prop,i;if(Array.isArray(obj)){for(i=0;i<obj.length;i++)deepFreeze(obj[i]);freeze(obj)}else if(null!==obj&&"object"==typeof obj){for(prop in obj)Object.hasOwn(obj,prop)&&deepFreeze(obj[prop]);freeze(obj)}}function freeze(obj){Object.isFrozen(obj)||Object.freeze(obj)}function unFreeze(obj){return Object.isFrozen(obj)?clone(obj,"shallow"):obj}var Utils={copyProperties:function(src,dest){var prop;for(prop in src)dest[prop]=src[prop]},resolveTransformObject:function(subObj,params,depth){var prop,pname;if("number"!=typeof depth&&(depth=0),++depth>=10)return subObj;for(prop in subObj)"string"==typeof subObj[prop]&&0===subObj[prop].indexOf("[%lktxp]")?(pname=subObj[prop].substring(8),Object.hasOwn(params,pname)&&(subObj[prop]=params[pname])):"object"==typeof subObj[prop]&&(subObj[prop]=Utils.resolveTransformObject(subObj[prop],params,depth));return subObj},resolveTransformParams:function(transform,params){var idx,clonedStep,resolvedTransform=[];if(void 0===params)return transform;for(idx=0;idx<transform.length;idx++)clonedStep=clone(transform[idx],"shallow-recurse-objects"),resolvedTransform.push(Utils.resolveTransformObject(clonedStep,params));return resolvedTransform},getIn:function(object,path,usingDotNotation){if(null!=object){if(!usingDotNotation)return object[path];if("string"==typeof path&&(path=path.split(".")),!Array.isArray(path))throw new Error("path must be a string or array. Found "+typeof path);for(var index=0,length=path.length;null!=object&&index<length;)object=object[path[index++]];return index&&index==length?object:void 0}}},Comparators={aeq:aeqHelper,lt:ltHelper,gt:gtHelper};function aeqHelper(prop1,prop2){var cv1,cv2,t1,t2;if(prop1===prop2)return!0;if(!prop1||!prop2||!0===prop1||!0===prop2||prop1!=prop1||prop2!=prop2){switch(prop1){case void 0:case null:t1=1;break;case!1:t1=3;break;case!0:t1=4;break;case"":t1=5;break;default:t1=prop1==prop1?9:0}switch(prop2){case void 0:case null:t2=1;break;case!1:t2=3;break;case!0:t2=4;break;case"":t2=5;break;default:t2=prop2==prop2?9:0}if(9!==t1||9!==t2)return t1===t2}return cv1=Number(prop1),cv2=Number(prop2),cv1==cv1||cv2==cv2?cv1===cv2:(cv1=prop1.toString())==(cv2=prop2.toString())}function ltHelper(prop1,prop2,equal){var cv1,cv2,t1,t2;if(!prop1||!prop2||!0===prop1||!0===prop2||prop1!=prop1||prop2!=prop2){switch(prop1){case void 0:case null:t1=1;break;case!1:t1=3;break;case!0:t1=4;break;case"":t1=5;break;default:t1=prop1==prop1?9:0}switch(prop2){case void 0:case null:t2=1;break;case!1:t2=3;break;case!0:t2=4;break;case"":t2=5;break;default:t2=prop2==prop2?9:0}if(9!==t1||9!==t2)return t1===t2?equal:t1<t2}return cv1=Number(prop1),cv2=Number(prop2),cv1==cv1&&cv2==cv2?cv1<cv2||!(cv1>cv2)&&equal:cv1==cv1&&cv2!=cv2||(cv2!=cv2||cv1==cv1)&&(prop1<prop2||!(prop1>prop2)&&(prop1==prop2?equal:(cv1=prop1.toString())<(cv2=prop2.toString())||cv1==cv2&&equal))}function gtHelper(prop1,prop2,equal){var cv1,cv2,t1,t2;if(!prop1||!prop2||!0===prop1||!0===prop2||prop1!=prop1||prop2!=prop2){switch(prop1){case void 0:case null:t1=1;break;case!1:t1=3;break;case!0:t1=4;break;case"":t1=5;break;default:t1=prop1==prop1?9:0}switch(prop2){case void 0:case null:t2=1;break;case!1:t2=3;break;case!0:t2=4;break;case"":t2=5;break;default:t2=prop2==prop2?9:0}if(9!==t1||9!==t2)return t1===t2?equal:t1>t2}return cv1=Number(prop1),cv2=Number(prop2),cv1==cv1&&cv2==cv2?cv1>cv2||!(cv1<cv2)&&equal:(cv1!=cv1||cv2==cv2)&&(cv2==cv2&&cv1!=cv1||(prop1>prop2||!(prop1<prop2)&&(prop1==prop2?equal:(cv1=prop1.toString())>(cv2=prop2.toString())||cv1==cv2&&equal)))}function sortHelper(prop1,prop2,desc){return Comparators.aeq(prop1,prop2)?0:Comparators.lt(prop1,prop2,!1)?desc?1:-1:Comparators.gt(prop1,prop2,!1)?desc?-1:1:0}function dotSubScan(root,paths,fun,value,extra,poffset){var element,pathOffset=poffset||0,path=paths[pathOffset],valueFound=!1;if(null!==root&&"object"==typeof root&&path in root&&(element=root[path]),pathOffset+1>=paths.length)valueFound=fun(element,value,extra);else if(Array.isArray(element))for(var index=0,len=element.length;index<len&&!0!==(valueFound=dotSubScan(element[index],paths,fun,value,extra,pathOffset+1));index+=1);else valueFound=dotSubScan(element,paths,fun,value,extra,pathOffset+1);return valueFound}function containsCheckFn(a){return"string"==typeof a||Array.isArray(a)?function(b){return-1!==a.indexOf(b)}:"object"==typeof a&&null!==a?function(b){return Object.hasOwn(a,b)}:null}function doQueryOp(val,op,record){for(var p in op)if(Object.hasOwn(op,p))return LokiOps[p](val,op[p],record);return!1}var LokiOps={$eq:function(a,b){return a===b},$aeq:function(a,b){return a==b},$ne:function(a,b){return b!=b?a==a:a!==b},$dteq:function(a,b){return Comparators.aeq(a,b)},$gt:function(a,b){return Comparators.gt(a,b,!1)},$gte:function(a,b){return Comparators.gt(a,b,!0)},$lt:function(a,b){return Comparators.lt(a,b,!1)},$lte:function(a,b){return Comparators.lt(a,b,!0)},$jgt:function(a,b){return a>b},$jgte:function(a,b){return a>=b},$jlt:function(a,b){return a<b},$jlte:function(a,b){return a<=b},$between:function(a,vals){return null!=a&&(Comparators.gt(a,vals[0],!0)&&Comparators.lt(a,vals[1],!0))},$jbetween:function(a,vals){return null!=a&&(a>=vals[0]&&a<=vals[1])},$in:function(a,b){return-1!==b.indexOf(a)},$inSet:function(a,b){return b.has(a)},$nin:function(a,b){return-1===b.indexOf(a)},$keyin:function(a,b){return a in b},$nkeyin:function(a,b){return!(a in b)},$definedin:function(a,b){return void 0!==b[a]},$undefinedin:function(a,b){return void 0===b[a]},$regex:function(a,b){return b.test(a)},$containsString:function(a,b){return"string"==typeof a&&-1!==a.indexOf(b)},$containsNone:function(a,b){return!LokiOps.$containsAny(a,b)},$containsAny:function(a,b){var checkFn=containsCheckFn(a);return null!==checkFn&&(Array.isArray(b)?b.some(checkFn):checkFn(b))},$contains:function(a,b){var checkFn=containsCheckFn(a);return null!==checkFn&&(Array.isArray(b)?b.every(checkFn):checkFn(b))},$elemMatch:function(a,b){return!!Array.isArray(a)&&a.some((function(item){return Object.keys(b).every((function(property){var filter=b[property];return"object"==typeof filter&&filter||(filter={$eq:filter}),-1!==property.indexOf(".")?dotSubScan(item,property.split("."),doQueryOp,b[property],item):doQueryOp(item[property],filter,item)}))}))},$type:function(a,b,record){var type=typeof a;return"object"===type&&(Array.isArray(a)?type="array":a instanceof Date&&(type="date")),"object"!=typeof b?type===b:doQueryOp(type,b,record)},$finite:function(a,b){return b===isFinite(a)},$size:function(a,b,record){return!!Array.isArray(a)&&("object"!=typeof b?a.length===b:doQueryOp(a.length,b,record))},$len:function(a,b,record){return"string"==typeof a&&("object"!=typeof b?a.length===b:doQueryOp(a.length,b,record))},$where:function(a,b){return!0===b(a)},$not:function(a,b,record){return!doQueryOp(a,b,record)},$and:function(a,b,record){for(var idx=0,len=b.length;idx<len;idx+=1)if(!doQueryOp(a,b[idx],record))return!1;return!0},$or:function(a,b,record){for(var idx=0,len=b.length;idx<len;idx+=1)if(doQueryOp(a,b[idx],record))return!0;return!1},$exists:function(a,b){return b?void 0!==a:void 0===a}};["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"].forEach((function(op){var fun=LokiOps[op];LokiOps["$"+op]=function(a,spec,record){if("string"==typeof spec)return fun(a,record[spec]);if("function"==typeof spec)return fun(a,spec(record));throw new Error("Invalid argument to $$ matcher")}}));var indexedOps={$eq:LokiOps.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function clone(data,method){if(null==data)return null;var cloned;switch(method||"parse-stringify"){case"parse-stringify":cloned=JSON.parse(JSON.stringify(data));break;case"jquery-extend-deep":cloned=jQuery.extend(!0,{},data);break;case"shallow":cloned=Object.create(data.constructor.prototype),Object.keys(data).map((function(i){cloned[i]=data[i]}));break;case"shallow-assign":cloned=Object.create(data.constructor.prototype),Object.assign(cloned,data);break;case"shallow-recurse-objects":cloned=clone(data,"shallow"),Object.keys(data).forEach((function(key){"object"==typeof data[key]&&"Object"===data[key].constructor.name?cloned[key]=clone(data[key],"shallow-recurse-objects"):Array.isArray(data[key])&&(cloned[key]=function(objarray,method){if("parse-stringify"==method)return clone(objarray,method);for(var result=[],i=0,len=objarray.length;i<len;i++)result[i]=clone(objarray[i],method);return result}(data[key],"shallow-recurse-objects"))}))}return cloned}function localStorageAvailable(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(e){return!1}}function LokiEventEmitter(){}function Loki(filename,options){this.filename=filename||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=!(!options||!Object.hasOwn(options,"verbose"))&&options.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};options&&Object.hasOwn(options,"env")?this.ENV=options.env:this.ENV="undefined"!=typeof global&&(global.android||global.NSObject)?"NATIVESCRIPT":"undefined"==typeof window||"undefined"!=typeof global&&global.window&&"undefined"!=typeof process?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA","undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(options,!0),this.on("init",this.clearChanges)}function LokiMemoryAdapter(options){this.hashStore={},this.options=options||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function LokiPartitioningAdapter(adapter,options){if(this.mode="reference",this.adapter=null,this.options=options||{},this.dbref=null,this.dbname="",this.pageIterator={},!adapter)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===adapter.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=adapter,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function LokiFsAdapter(){try{this.fs=require("fs")}catch(e){this.fs=null}}function LokiLocalStorageAdapter(){}function Resultset(collection,options){return this.options=options||{},this.collection=collection,this.filteredrows=[],this.filterInitialized=!1,this}function precompileQuery(operator,value){if("$regex"===operator)Array.isArray(value)?value=new RegExp(value[0],value[1]):value instanceof RegExp||(value=new RegExp(value));else if("object"==typeof value)for(var key in value)"$regex"!==key&&"object"!=typeof value[key]||(value[key]=precompileQuery(key,value[key]));return value}function DynamicView(collection,name,options){this.collection=collection,this.name=name,this.rebuildPending=!1,this.options=options||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new Resultset(collection),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}LokiEventEmitter.prototype.events={},LokiEventEmitter.prototype.asyncListeners=!1,LokiEventEmitter.prototype.on=function(eventName,listener){var event,self=this;return Array.isArray(eventName)?(eventName.forEach((function(currentEventName){self.on(currentEventName,listener)})),listener):((event=this.events[eventName])||(event=this.events[eventName]=[]),event.push(listener),listener)},LokiEventEmitter.prototype.emit=function(eventName){var selfArgs,self=this;if(!eventName||!this.events[eventName])throw new Error("No event "+eventName+" defined");this.events[eventName].length&&(selfArgs=Array.prototype.slice.call(arguments,1),this.events[eventName].forEach((function(listener){self.asyncListeners?setTimeout((function(){listener.apply(self,selfArgs)}),1):listener.apply(self,selfArgs)})))},LokiEventEmitter.prototype.addListener=LokiEventEmitter.prototype.on,LokiEventEmitter.prototype.removeListener=function(eventName,listener){var self=this;if(Array.isArray(eventName))eventName.forEach((function(currentEventName){self.removeListener(currentEventName,listener)}));else if(this.events[eventName]){var listeners=this.events[eventName];listeners.splice(listeners.indexOf(listener),1)}},Loki.prototype=new LokiEventEmitter,Loki.prototype.constructor=Loki,Loki.prototype.getIndexedAdapter=function(){var adapter;return"function"==typeof require&&(adapter=require("./loki-indexed-adapter.js")),adapter},Loki.prototype.configureOptions=function(options,initialConfig){var persistenceMethods={fs:LokiFsAdapter,localStorage:LokiLocalStorageAdapter,memory:LokiMemoryAdapter};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==options){if(this.options=options,Object.hasOwn(this.options,"persistenceMethod")&&"function"==typeof persistenceMethods[options.persistenceMethod]&&(this.persistenceMethod=options.persistenceMethod,this.persistenceAdapter=new persistenceMethods[options.persistenceMethod]),Object.hasOwn(this.options,"adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=options.adapter,this.options.adapter=null,this.isIncremental="incremental"===this.persistenceAdapter.mode),options.autoload&&initialConfig){var self=this;setTimeout((function(){self.loadDatabase(options,options.autoloadCallback)}),1)}Object.hasOwn(this.options,"autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),Object.hasOwn(this.options,"autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,Object.hasOwn(this.options,"autosaveCallback")?this.autosaveEnable(options,options.autosaveCallback):this.autosaveEnable()),Object.hasOwn(this.options,"throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}Object.hasOwn(this.options,"serializationMethod")||(this.options.serializationMethod="normal"),Object.hasOwn(this.options,"destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"}[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new persistenceMethods[this.persistenceMethod]))},Loki.prototype.copy=function(options){var clen,idx,databaseCopy=new Loki(this.filename,{env:"NA"});if(options=options||{},databaseCopy.loadJSONObject(this,{retainDirtyFlags:!0}),options.hasOwnProperty("removeNonSerializable")&&!0===options.removeNonSerializable)for(databaseCopy.autosaveHandle=null,databaseCopy.persistenceAdapter=null,clen=databaseCopy.collections.length,idx=0;idx<clen;idx++)databaseCopy.collections[idx].constraints=null,databaseCopy.collections[idx].ttl=null;return databaseCopy},Loki.prototype.addCollection=function(name,options){var i,len=this.collections.length;if(options&&!0===options.disableMeta){if(!1===options.disableChangesApi)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(!1===options.disableDeltaChangesApi)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"==typeof options.ttl&&options.ttl>0)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<len;i+=1)if(this.collections[i].name===name)return this.collections[i];var collection=new Collection(name,options);return collection.isIncremental=this.isIncremental,this.collections.push(collection),this.verbose&&(collection.lokiConsoleWrapper=console),collection},Loki.prototype.loadCollection=function(collection){if(!collection.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(collection)},Loki.prototype.getCollection=function(collectionName){var i,len=this.collections.length;for(i=0;i<len;i+=1)if(this.collections[i].name===collectionName)return this.collections[i];return this.emit("warning","collection "+collectionName+" not found"),null},Loki.prototype.renameCollection=function(oldName,newName){var c=this.getCollection(oldName);return c&&(c.name=newName),c},Loki.prototype.listCollections=function(){for(var i=this.collections.length,colls=[];i--;)colls.push({name:this.collections[i].name,type:this.collections[i].objType,count:this.collections[i].data.length});return colls},Loki.prototype.removeCollection=function(collectionName){var i,len=this.collections.length;for(i=0;i<len;i+=1)if(this.collections[i].name===collectionName){var tmpcol=new Collection(collectionName,{}),curcol=this.collections[i];for(var prop in curcol)curcol.hasOwnProperty(prop)&&tmpcol.hasOwnProperty(prop)&&(curcol[prop]=tmpcol[prop]);return void this.collections.splice(i,1)}},Loki.prototype.getName=function(){return this.name},Loki.prototype.serializeReplacer=function(key,value){switch(key){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":case"lokiConsoleWrapper":return null;case"throttledSavePending":case"throttledCallbacks":return;default:return value}},Loki.prototype.serialize=function(options){switch((options=options||{}).hasOwnProperty("serializationMethod")||(options.serializationMethod=this.options.serializationMethod),options.serializationMethod){case"normal":default:return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured()}},Loki.prototype.toJson=Loki.prototype.serialize,Loki.prototype.serializeDestructured=function(options){var idx,sidx,result,resultlen,dbcopy,reconstruct=[];if((options=options||{}).hasOwnProperty("partitioned")||(options.partitioned=!1),options.hasOwnProperty("delimited")||(options.delimited=!0),options.hasOwnProperty("delimiter")||(options.delimiter=this.options.destructureDelimiter),!0===options.partitioned&&options.hasOwnProperty("partition")&&options.partition>=0)return this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:options.partition});for((dbcopy=new Loki(this.filename)).loadJSONObject(this),idx=0;idx<dbcopy.collections.length;idx++)dbcopy.collections[idx].data=[];if(!0===options.partitioned&&-1===options.partition)return dbcopy.serialize({serializationMethod:"normal"});for(reconstruct.push(dbcopy.serialize({serializationMethod:"normal"})),dbcopy=null,idx=0;idx<this.collections.length;idx++)if(result=this.serializeCollection({delimited:options.delimited,delimiter:options.delimiter,collectionIndex:idx}),!1===options.partitioned&&!1===options.delimited){if(!Array.isArray(result))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(resultlen=result.length,sidx=0;sidx<resultlen;sidx++)reconstruct.push(result[sidx]),result[sidx]=null;reconstruct.push("")}else reconstruct.push(result);return options.partitioned?(options.delimited,reconstruct):options.delimited?(reconstruct.push(""),reconstruct.join(options.delimiter)):(reconstruct.push(""),reconstruct)},Loki.prototype.serializeCollection=function(options){var doccount,docidx,resultlines=[];if((options=options||{}).hasOwnProperty("delimited")||(options.delimited=!0),!options.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(doccount=this.collections[options.collectionIndex].data.length,resultlines=[],docidx=0;docidx<doccount;docidx++)resultlines.push(JSON.stringify(this.collections[options.collectionIndex].data[docidx]));return options.delimited?(resultlines.push(""),resultlines.join(options.delimiter)):resultlines},Loki.prototype.deserializeDestructured=function(destructuredSource,options){var cdb,collCount,currObject,workarray=[],collIndex=0,lineIndex=1,done=!1;if((options=options||{}).hasOwnProperty("partitioned")||(options.partitioned=!1),options.hasOwnProperty("delimited")||(options.delimited=!0),options.hasOwnProperty("delimiter")||(options.delimiter=this.options.destructureDelimiter),options.partitioned){if(options.hasOwnProperty("partition"))return-1===options.partition?cdb=JSON.parse(destructuredSource[0]):this.deserializeCollection(destructuredSource[options.partition+1],options);for(collCount=(cdb=JSON.parse(destructuredSource[0])).collections.length,collIndex=0;collIndex<collCount;collIndex++)cdb.collections[collIndex].data=this.deserializeCollection(destructuredSource[collIndex+1],options);return cdb}if(options.delimited){if(workarray=destructuredSource.split(options.delimiter),destructuredSource=null,0===workarray.length)return null}else workarray=destructuredSource;for(collCount=(cdb=JSON.parse(workarray[0])).collections.length,workarray[0]=null;!done;)workarray[lineIndex],""===workarray[lineIndex]?++collIndex>collCount&&(done=!0):(currObject=JSON.parse(workarray[lineIndex]),cdb.collections[collIndex].data.push(currObject)),workarray[lineIndex++]=null;return cdb},Loki.prototype.deserializeCollection=function(destructuredSource,options){var idx,len,workarray=[];for((options=options||{}).hasOwnProperty("partitioned")||(options.partitioned=!1),options.hasOwnProperty("delimited")||(options.delimited=!0),options.hasOwnProperty("delimiter")||(options.delimiter=this.options.destructureDelimiter),options.delimited?(workarray=destructuredSource.split(options.delimiter)).pop():workarray=destructuredSource,len=workarray.length,idx=0;idx<len;idx++)workarray[idx]=JSON.parse(workarray[idx]);return workarray},Loki.prototype.loadJSON=function(serializedDb,options){var dbObject;if(0===serializedDb.length)dbObject={};else switch(this.options.serializationMethod){case"normal":case"pretty":default:dbObject=JSON.parse(serializedDb);break;case"destructured":dbObject=this.deserializeDestructured(serializedDb)}this.loadJSONObject(dbObject,options)},Loki.prototype.loadJSONObject=function(dbObject,options){var coll,copyColl,clen,j,loader,collObj,i=0,len=dbObject.collections?dbObject.collections.length:0;function makeLoader(coll){var inflater,collOptions=options[coll.name];return collOptions.proto?(inflater=collOptions.inflate||Utils.copyProperties,function(data){var collObj=new collOptions.proto;return inflater(data,collObj),collObj}):collOptions.inflate}for(this.name=dbObject.name,dbObject.hasOwnProperty("throttledSaves")&&options&&!options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=dbObject.throttledSaves),this.collections=[];i<len;i+=1){if(coll=dbObject.collections[i],(copyColl=this.addCollection(coll.name,{disableChangesApi:coll.disableChangesApi,disableDeltaChangesApi:coll.disableDeltaChangesApi,disableMeta:coll.disableMeta,disableFreeze:!coll.hasOwnProperty("disableFreeze")||coll.disableFreeze})).adaptiveBinaryIndices=!!coll.hasOwnProperty("adaptiveBinaryIndices")&&!0===coll.adaptiveBinaryIndices,copyColl.transactional=coll.transactional,copyColl.asyncListeners=coll.asyncListeners,copyColl.cloneObjects=coll.cloneObjects,copyColl.cloneMethod=coll.cloneMethod||"parse-stringify",copyColl.autoupdate=coll.autoupdate,copyColl.changes=coll.changes,copyColl.dirtyIds=coll.dirtyIds||[],options&&!0===options.retainDirtyFlags?copyColl.dirty=coll.dirty:copyColl.dirty=!1,coll.getData){if(options&&options.hasOwnProperty(coll.name)||!copyColl.disableFreeze||copyColl.autoupdate)throw new Error("this collection cannot be loaded lazily: "+coll.name);copyColl.getData=coll.getData,Object.defineProperty(copyColl,"data",{get:function(){var data=this.getData();return this.getData=null,Object.defineProperty(this,"data",{value:data}),data}})}else if(clen=coll.data.length,j=0,options&&options.hasOwnProperty(coll.name))for(loader=makeLoader(coll);j<clen;j++)collObj=loader(coll.data[j]),copyColl.data[j]=collObj,copyColl.addAutoUpdateObserver(collObj),copyColl.disableFreeze||deepFreeze(copyColl.data[j]);else for(;j<clen;j++)copyColl.data[j]=coll.data[j],copyColl.addAutoUpdateObserver(copyColl.data[j]),copyColl.disableFreeze||deepFreeze(copyColl.data[j]);if(copyColl.maxId=void 0===coll.maxId?0:coll.maxId,void 0!==coll.binaryIndices&&(copyColl.binaryIndices=coll.binaryIndices),void 0!==coll.transforms&&(copyColl.transforms=coll.transforms),copyColl.uniqueNames=[],coll.hasOwnProperty("uniqueNames")&&(copyColl.uniqueNames=coll.uniqueNames),void 0!==coll.DynamicViews){for(var idx=0;idx<coll.DynamicViews.length;idx++){var colldv=coll.DynamicViews[idx],dv=copyColl.addDynamicView(colldv.name,colldv.options);dv.resultdata=colldv.resultdata,dv.resultsdirty=colldv.resultsdirty,dv.filterPipeline=colldv.filterPipeline,dv.sortCriteriaSimple=colldv.sortCriteriaSimple,dv.sortCriteria=colldv.sortCriteria,dv.sortFunction=null,dv.sortDirty=colldv.sortDirty,copyColl.disableFreeze||(deepFreeze(dv.filterPipeline),dv.sortCriteriaSimple?deepFreeze(dv.sortCriteriaSimple):dv.sortCriteria&&deepFreeze(dv.sortCriteria)),dv.resultset.filteredrows=colldv.resultset.filteredrows,dv.resultset.filterInitialized=colldv.resultset.filterInitialized,dv.rematerialize({removeWhereFilters:!0})}dbObject.databaseVersion<1.5&&(copyColl.ensureAllIndexes(!0),copyColl.dirty=!0)}}},Loki.prototype.close=function(callback){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(callback),callback=void 0)),callback&&this.on("close",callback),this.emit("close")},Loki.prototype.generateChangesNotification=function(arrayOfCollectionNames){function getCollName(coll){return coll.name}var changes=[],selectedCollections=arrayOfCollectionNames||this.collections.map(getCollName);return this.collections.forEach((function(coll){-1!==selectedCollections.indexOf(getCollName(coll))&&(changes=changes.concat(coll.getChanges()))})),changes},Loki.prototype.serializeChanges=function(collectionNamesArray){return JSON.stringify(this.generateChangesNotification(collectionNamesArray))},Loki.prototype.clearChanges=function(){this.collections.forEach((function(coll){coll.flushChanges&&coll.flushChanges()}))},LokiMemoryAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;this.options.asyncResponses?setTimeout((function(){self.hashStore.hasOwnProperty(dbname)?callback(self.hashStore[dbname].value):callback(null)}),this.options.asyncTimeout):this.hashStore.hasOwnProperty(dbname)?callback(this.hashStore[dbname].value):callback(null)},LokiMemoryAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){var saveCount,self=this;this.options.asyncResponses?setTimeout((function(){saveCount=self.hashStore.hasOwnProperty(dbname)?self.hashStore[dbname].savecount:0,self.hashStore[dbname]={savecount:saveCount+1,lastsave:new Date,value:dbstring},callback()}),this.options.asyncTimeout):(saveCount=this.hashStore.hasOwnProperty(dbname)?this.hashStore[dbname].savecount:0,this.hashStore[dbname]={savecount:saveCount+1,lastsave:new Date,value:dbstring},callback())},LokiMemoryAdapter.prototype.deleteDatabase=function(dbname,callback){this.hashStore.hasOwnProperty(dbname)&&delete this.hashStore[dbname],"function"==typeof callback&&callback()},LokiPartitioningAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;this.dbname=dbname,this.dbref=new Loki(dbname),this.adapter.loadDatabase(dbname,(function(result){if(result){"string"!=typeof result&&callback(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var db=JSON.parse(result);self.dbref.loadJSONObject(db),db=null,0!==self.dbref.collections.length?(self.pageIterator={collection:0,pageIndex:0},self.loadNextPartition(0,(function(){callback(self.dbref)}))):callback(self.dbref)}else callback(result)}))},LokiPartitioningAdapter.prototype.loadNextPartition=function(partition,callback){var keyname=this.dbname+"."+partition,self=this;if(!0===this.options.paging)return this.pageIterator.pageIndex=0,void this.loadNextPage(callback);this.adapter.loadDatabase(keyname,(function(result){var data=self.dbref.deserializeCollection(result,{delimited:!0,collectionIndex:partition});self.dbref.collections[partition].data=data,++partition<self.dbref.collections.length?self.loadNextPartition(partition,callback):callback()}))},LokiPartitioningAdapter.prototype.loadNextPage=function(callback){var keyname=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,self=this;this.adapter.loadDatabase(keyname,(function(result){var data=result.split(self.options.delimiter);result="";var idx,dlen=data.length,isLastPage=""===data[dlen-1];for(isLastPage&&(data.pop(),""===data[(dlen=data.length)-1]&&1===dlen&&(data.pop(),dlen=data.length)),idx=0;idx<dlen;idx++)self.dbref.collections[self.pageIterator.collection].data.push(JSON.parse(data[idx])),data[idx]=null;data=[],isLastPage?++self.pageIterator.collection<self.dbref.collections.length?self.loadNextPartition(self.pageIterator.collection,callback):callback():(self.pageIterator.pageIndex++,self.loadNextPage(callback))}))},LokiPartitioningAdapter.prototype.exportDatabase=function(dbname,dbref,callback){var idx,clen=dbref.collections.length;for(this.dbref=dbref,this.dbname=dbname,this.dirtyPartitions=[-1],idx=0;idx<clen;idx++)dbref.collections[idx].dirty&&this.dirtyPartitions.push(idx);this.saveNextPartition((function(err){callback(err)}))},LokiPartitioningAdapter.prototype.saveNextPartition=function(callback){var self=this,partition=this.dirtyPartitions.shift(),keyname=this.dbname+(-1===partition?"":"."+partition);if(this.options.paging&&-1!==partition)return this.pageIterator={collection:partition,docIndex:0,pageIndex:0},void this.saveNextPage((function(err){0===self.dirtyPartitions.length?callback(err):self.saveNextPartition(callback)}));var result=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:partition});this.adapter.saveDatabase(keyname,result,(function(err){err?callback(err):0===self.dirtyPartitions.length?callback(null):self.saveNextPartition(callback)}))},LokiPartitioningAdapter.prototype.saveNextPage=function(callback){var self=this,coll=this.dbref.collections[this.pageIterator.collection],keyname=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,pageLen=0,cdlen=coll.data.length,delimlen=this.options.delimiter.length,serializedObject="",pageBuilder="",doneWithPartition=!1,doneWithPage=!1,pageSaveCallback=function(err){pageBuilder="",err&&callback(err),doneWithPartition?callback(null):(self.pageIterator.pageIndex++,self.saveNextPage(callback))};for(0===coll.data.length&&(doneWithPartition=!0);;)if(doneWithPartition||(serializedObject=JSON.stringify(coll.data[this.pageIterator.docIndex]),pageBuilder+=serializedObject,pageLen+=serializedObject.length,++this.pageIterator.docIndex>=cdlen&&(doneWithPartition=!0)),pageLen>=this.options.pageSize&&(doneWithPage=!0),doneWithPage&&!doneWithPartition||(pageBuilder+=this.options.delimiter,pageLen+=delimlen),doneWithPartition||doneWithPage)return void this.adapter.saveDatabase(keyname,pageBuilder,pageSaveCallback)},LokiFsAdapter.prototype.loadDatabase=function(dbname,callback){var self=this;this.fs.stat(dbname,(function(err,stats){!err&&stats.isFile()?self.fs.readFile(dbname,{encoding:"utf8"},(function(err,data){callback(err?new Error(err):data)})):callback(null)}))},LokiFsAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){var self=this,tmpdbname=dbname+"~";this.fs.writeFile(tmpdbname,dbstring,(function(err){err?callback(new Error(err)):self.fs.rename(tmpdbname,dbname,callback)}))},LokiFsAdapter.prototype.deleteDatabase=function(dbname,callback){this.fs.unlink(dbname,(function(err){err?callback(new Error(err)):callback()}))},LokiLocalStorageAdapter.prototype.loadDatabase=function(dbname,callback){localStorageAvailable()?callback(localStorage.getItem(dbname)):callback(new Error("localStorage is not available"))},LokiLocalStorageAdapter.prototype.saveDatabase=function(dbname,dbstring,callback){localStorageAvailable()?(localStorage.setItem(dbname,dbstring),callback(null)):callback(new Error("localStorage is not available"))},LokiLocalStorageAdapter.prototype.deleteDatabase=function(dbname,callback){localStorageAvailable()?(localStorage.removeItem(dbname),callback(null)):callback(new Error("localStorage is not available"))},Loki.prototype.throttledSaveDrain=function(callback,options){var self=this,now=(new Date).getTime();if(this.throttledSaves||callback(!0),(options=options||{}).hasOwnProperty("recursiveWait")||(options.recursiveWait=!0),options.hasOwnProperty("recursiveWaitLimit")||(options.recursiveWaitLimit=!1),options.hasOwnProperty("recursiveWaitLimitDuration")||(options.recursiveWaitLimitDuration=2e3),options.hasOwnProperty("started")||(options.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending){if(!options.recursiveWait)return void this.throttledCallbacks.push(callback);this.throttledCallbacks.push((function(){return self.throttledSavePending?options.recursiveWaitLimit&&now-options.started>options.recursiveWaitLimitDuration?void callback(!1):void self.throttledSaveDrain(callback,options):void callback(!0)}))}else callback(!0)},Loki.prototype.loadDatabaseInternal=function(options,callback){var cFun=callback||function(err){if(err)throw err},self=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,(function(dbString){if("string"==typeof dbString){var parseSuccess=!1;try{self.loadJSON(dbString,options||{}),parseSuccess=!0}catch(err){cFun(err)}parseSuccess&&(cFun(null),self.emit("loaded","database "+self.filename+" loaded"))}else{if(!dbString)return cFun(null),void self.emit("loaded","empty database "+self.filename+" loaded");if(dbString instanceof Error)return void cFun(dbString);if("object"==typeof dbString)return self.loadJSONObject(dbString,options||{}),cFun(null),void self.emit("loaded","database "+self.filename+" loaded");cFun("unexpected adapter response : "+dbString)}})):cFun(new Error("persistenceAdapter not configured"))},Loki.prototype.loadDatabase=function(options,callback){var self=this;this.throttledSaves?this.throttledSaveDrain((function(success){if(success)return self.throttledSavePending=!0,void self.loadDatabaseInternal(options,(function(err){0===self.throttledCallbacks.length?self.throttledSavePending=!1:self.saveDatabase(),"function"==typeof callback&&callback(err)}));"function"==typeof callback&&callback(new Error("Unable to pause save throttling long enough to read database"))}),options):this.loadDatabaseInternal(options,callback)},Loki.prototype.saveDatabaseInternal=function(callback){var cachedDirty,cFun=callback||function(err){if(err)throw err},self=this;this.persistenceAdapter?"incremental"===this.persistenceAdapter.mode?(this.ignoreAutosave=!0,this.persistenceAdapter.saveDatabase(this.filename,(function(){if(self.ignoreAutosave=!1,!cachedDirty){var lokiCopy=self.copy({removeNonSerializable:!0});return cachedDirty=self.collections.map((function(collection){return[collection.dirty,collection.dirtyIds]})),self.collections.forEach((function(col){col.dirty=!1,col.dirtyIds=[]})),lokiCopy}cFun(new Error("adapter error - getLokiCopy called more than once"))}),(function(err){self.ignoreAutosave=!1,err&&cachedDirty&&self.collections.forEach((function(col,i){var cached=cachedDirty[i];col.dirty=col.dirty||cached[0],col.dirtyIds=col.dirtyIds.concat(cached[1])})),cFun(err)}))):"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),(function(err){self.autosaveClearFlags(),cFun(err)})):(this.autosaveClearFlags(),this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),(function(err){cFun(err)}))):cFun(new Error("persistenceAdapter not configured"))},Loki.prototype.saveDatabase=function(callback){if(this.throttledSaves)if(this.throttledSavePending)this.throttledCallbacks.push(callback);else{var localCallbacks=this.throttledCallbacks;this.throttledCallbacks=[],localCallbacks.unshift(callback),this.throttledSavePending=!0;var self=this;this.saveDatabaseInternal((function(err){self.throttledSavePending=!1,localCallbacks.forEach((function(pcb){"function"==typeof pcb&&setTimeout((function(){pcb(err)}),1)})),self.throttledCallbacks.length>0&&self.saveDatabase()}))}else this.saveDatabaseInternal(callback)},Loki.prototype.save=Loki.prototype.saveDatabase,Loki.prototype.deleteDatabase=function(options,callback){var cFun=callback||function(err){if(err)throw err};"function"!=typeof options||callback||(cFun=options),null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,(function(err){cFun(err)})):cFun(new Error("persistenceAdapter not configured"))},Loki.prototype.autosaveDirty=function(){for(var idx=0;idx<this.collections.length;idx++)if(this.collections[idx].dirty)return!0;return!1},Loki.prototype.autosaveClearFlags=function(){for(var idx=0;idx<this.collections.length;idx++)this.collections[idx].dirty=!1},Loki.prototype.autosaveEnable=function(options,callback){this.autosave=!0;var delay=5e3,self=this;void 0!==this.autosaveInterval&&null!==this.autosaveInterval&&(delay=this.autosaveInterval),this.autosaveHandle=setInterval((function(){self.autosaveDirty()&&!self.ignoreAutosave&&self.saveDatabase(callback)}),delay)},Loki.prototype.autosaveDisable=function(){void 0!==this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},Resultset.prototype.reset=function(){return this.filteredrows.length>0&&(this.filteredrows=[]),this.filterInitialized=!1,this},Resultset.prototype.toJSON=function(){var copy=this.copy();return copy.collection=null,copy},Resultset.prototype.limit=function(qty){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var rscopy=new Resultset(this.collection);return rscopy.filteredrows=this.filteredrows.slice(0,qty),rscopy.filterInitialized=!0,rscopy},Resultset.prototype.offset=function(pos){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var rscopy=new Resultset(this.collection);return rscopy.filteredrows=this.filteredrows.slice(pos),rscopy.filterInitialized=!0,rscopy},Resultset.prototype.copy=function(){var result=new Resultset(this.collection);return this.filteredrows.length>0&&(result.filteredrows=this.filteredrows.slice()),result.filterInitialized=this.filterInitialized,result},Resultset.prototype.branch=Resultset.prototype.copy,Resultset.prototype.transform=function(transform,parameters){var idx,step,rs=this;if("string"==typeof transform&&this.collection.transforms.hasOwnProperty(transform)&&(transform=this.collection.transforms[transform]),"object"!=typeof transform||!Array.isArray(transform))throw new Error("Invalid transform");for(void 0!==parameters&&(transform=Utils.resolveTransformParams(transform,parameters)),idx=0;idx<transform.length;idx++)switch((step=transform[idx]).type){case"find":rs.find(step.value);break;case"where":rs.where(step.value);break;case"simplesort":rs.simplesort(step.property,step.desc||step.options);break;case"compoundsort":rs.compoundsort(step.value);break;case"sort":rs.sort(step.value);break;case"limit":rs=rs.limit(step.value);break;case"offset":rs=rs.offset(step.value);break;case"map":rs=rs.map(step.value,step.dataOptions);break;case"eqJoin":rs=rs.eqJoin(step.joinData,step.leftJoinKey,step.rightJoinKey,step.mapFun,step.dataOptions);break;case"mapReduce":rs=rs.mapReduce(step.mapFunction,step.reduceFunction);break;case"update":rs.update(step.value);break;case"remove":rs.remove()}return rs},Resultset.prototype.sort=function(comparefun){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var userComparer,data,wrappedComparer=(userComparer=comparefun,data=this.collection.data,function(a,b){return userComparer(data[a],data[b])});return this.filteredrows.sort(wrappedComparer),this},Resultset.prototype.simplesort=function(propname,options){var eff,targetEff=10,dc=this.collection.data.length,frl=this.filteredrows.length,hasBinaryIndex=this.collection.binaryIndices.hasOwnProperty(propname);if(void 0!==options&&!1!==options||(options={desc:!1}),!0===options&&(options={desc:!0}),0===frl){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(propname))return this.collection.ensureIndex(propname),this.filteredrows=this.collection.binaryIndices[propname].values.slice(0),options.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!options.disableIndexIntersect&&hasBinaryIndex&&(eff=dc/frl,options.useJavascriptSorting&&(targetEff=6),eff<=targetEff||options.forceIndexIntersect)){var idx,fr=this.filteredrows,io={};for(idx=0;idx<frl;idx++)io[fr[idx]]=!0;var pv=this.collection.binaryIndices[propname].values;return this.filteredrows=pv.filter((function(n){return io[n]})),options.desc&&this.filteredrows.reverse(),this}if(options.useJavascriptSorting)return this.sort((function(obj1,obj2){return obj1[propname]===obj2[propname]?0:obj1[propname]>obj2[propname]?1:obj1[propname]<obj2[propname]?-1:void 0}));var prop,desc,data,val1,val2,arr,wrappedComparer=(prop=propname,desc=options.desc,data=this.collection.data,function(a,b){return~prop.indexOf(".")?(arr=prop.split("."),val1=Utils.getIn(data[a],arr,!0),val2=Utils.getIn(data[b],arr,!0)):(val1=data[a][prop],val2=data[b][prop]),sortHelper(val1,val2,desc)});return this.filteredrows.sort(wrappedComparer),this},Resultset.prototype.compoundsort=function(properties){if(0===properties.length)throw new Error("Invalid call to compoundsort, need at least one property");var prop;if(1===properties.length)return prop=properties[0],Array.isArray(prop)?this.simplesort(prop[0],prop[1]):this.simplesort(prop,!1);for(var i=0,len=properties.length;i<len;i+=1)prop=properties[i],Array.isArray(prop)||(properties[i]=[prop,!1]);this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var props,data,wrappedComparer=(props=properties,data=this.collection.data,function(a,b){return function(properties,obj1,obj2){for(var prop,field,val1,val2,arr,res=0,i=0,len=properties.length;i<len;i++)if(~(field=(prop=properties[i])[0]).indexOf(".")?(arr=field.split("."),val1=Utils.getIn(obj1,arr,!0),val2=Utils.getIn(obj2,arr,!0)):(val1=obj1[field],val2=obj2[field]),0!==(res=sortHelper(val1,val2,prop[1])))return res;return 0}(props,data[a],data[b])});return this.filteredrows.sort(wrappedComparer),this},Resultset.prototype.findOr=function(expressionArray){for(var fr=null,fri=0,frlen=0,docset=[],idxset=[],idx=0,ei=0,elen=expressionArray.length;ei<elen;ei++)for(frlen=(fr=this.branch().find(expressionArray[ei]).filteredrows).length,fri=0;fri<frlen;fri++)void 0===idxset[idx=fr[fri]]&&(idxset[idx]=!0,docset.push(idx));return this.filteredrows=docset,this.filterInitialized=!0,this},Resultset.prototype.$or=Resultset.prototype.findOr,Resultset.prototype.findAnd=function(expressionArray){for(var i=0,len=expressionArray.length;i<len;i++){if(0===this.count())return this;this.find(expressionArray[i])}return this},Resultset.prototype.$and=Resultset.prototype.findAnd,Resultset.prototype.find=function(query,firstOnly){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=!0,this;var p,property,queryObjectOp,obj,operator,value,key,queryObject=query||"getAll",searchByIndex=!1,result=[],filters=[],index=null;if(firstOnly=firstOnly||!1,"object"==typeof queryObject){for(p in queryObject)(obj={})[p]=queryObject[p],filters.push(obj),hasOwnProperty.call(queryObject,p)&&(property=p,queryObjectOp=queryObject[p]);if(filters.length>1)return this.find({$and:filters},firstOnly)}if(!property||"getAll"===queryObject)return firstOnly&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=this.collection.data.length>0?[0]:[],this.filterInitialized=!0)),this;if("$and"===property||"$or"===property)return this[property](queryObjectOp),firstOnly&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(null===queryObjectOp||"object"!=typeof queryObjectOp||queryObjectOp instanceof Date)operator="$eq",value=queryObjectOp;else{if("object"!=typeof queryObjectOp)throw new Error("Do not know what you want to do.");for(key in queryObjectOp)if(hasOwnProperty.call(queryObjectOp,key)){operator=key,value=queryObjectOp[key];break}}"$regex"!==operator&&"object"!=typeof value||(value=precompileQuery(operator,value));var usingDotNotation=-1!==property.indexOf(".");!this.filterInitialized&&this.collection.binaryIndices[property]&&indexedOps[operator]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(property),searchByIndex=!0,index=this.collection.binaryIndices[property]),!searchByIndex&&"$in"===operator&&Array.isArray(value)&&"undefined"!=typeof Set&&(value=new Set(value),operator="$inSet");var filter,record,fun=LokiOps[operator],t=this.collection.data,i=0,len=0,rowIdx=0;if(this.filterInitialized){if(len=(filter=this.filteredrows).length,usingDotNotation){for(property=property.split("."),i=0;i<len;i++)if(dotSubScan(record=t[rowIdx=filter[i]],property,fun,value,record)&&(result.push(rowIdx),firstOnly))return this.filteredrows=result,this}else for(i=0;i<len;i++)if(fun((record=t[rowIdx=filter[i]])[property],value,record)&&(result.push(rowIdx),firstOnly))return this.filteredrows=result,this}else if(searchByIndex){var segm=this.collection.calculateRange(operator,property,value);if("$in"!==operator){for(i=segm[0];i<=segm[1];i++)if(!0!==indexedOps[operator]){if(indexedOps[operator](Utils.getIn(t[index.values[i]],property,usingDotNotation),value)&&(result.push(index.values[i]),firstOnly))return this.filteredrows=result,this.filterInitialized=!0,this}else if(result.push(index.values[i]),firstOnly)return this.filteredrows=result,this.filterInitialized=!0,this}else for(i=0,len=segm.length;i<len;i++)if(result.push(index.values[segm[i]]),firstOnly)return this.filteredrows=result,this.filterInitialized=!0,this}else if(len=t.length,usingDotNotation){for(property=property.split("."),i=0;i<len;i++)if(dotSubScan(record=t[i],property,fun,value,record)&&(result.push(i),firstOnly))return this.filteredrows=result,this.filterInitialized=!0,this}else for(i=0;i<len;i++)if(fun((record=t[i])[property],value,record)&&(result.push(i),firstOnly))return this.filteredrows=result,this.filterInitialized=!0,this;return this.filteredrows=result,this.filterInitialized=!0,this},Resultset.prototype.where=function(fun){var viewFunction,result=[];if("function"!=typeof fun)throw new TypeError("Argument is not a stored view or a function");viewFunction=fun;try{if(this.filterInitialized){for(var j=this.filteredrows.length;j--;)!0===viewFunction(this.collection.data[this.filteredrows[j]])&&result.push(this.filteredrows[j]);return this.filteredrows=result,this}for(var k=this.collection.data.length;k--;)!0===viewFunction(this.collection.data[k])&&result.push(k);return this.filteredrows=result,this.filterInitialized=!0,this}catch(err){throw err}},Resultset.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:this.collection.count()},Resultset.prototype.data=function(options){var obj,len,i,method,result=[],data=this.collection.data;if((options=options||{}).removeMeta&&!options.forceClones&&(options.forceClones=!0,options.forceCloneMethod=options.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(options.forceClones=!0,options.forceCloneMethod="parse-stringify"),!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||options.forceClones){for(len=data.length,method=options.forceCloneMethod||this.collection.cloneMethod,i=0;i<len;i++)obj=clone(data[i],method),options.removeMeta&&(delete obj.$loki,delete obj.meta),result.push(obj);return result}return data.slice()}this.filterInitialized=!0}var fr=this.filteredrows;if(len=fr.length,this.collection.cloneObjects||options.forceClones)for(method=options.forceCloneMethod||this.collection.cloneMethod,i=0;i<len;i++)obj=clone(data[fr[i]],method),options.removeMeta&&(delete obj.$loki,delete obj.meta),result.push(obj);else for(i=0;i<len;i++)result.push(data[fr[i]]);return result},Resultset.prototype.update=function(updateFunction){if("function"!=typeof updateFunction)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());for(var obj,len=this.filteredrows.length,rcd=this.collection.data,idx=0;idx<len;idx++)this.disableFreeze&&!this.collection.cloneObjects&&this.collection.disableDeltaChangesApi?(updateFunction(rcd[this.filteredrows[idx]]),this.collection.update(rcd[this.filteredrows[idx]])):(updateFunction(obj=clone(rcd[this.filteredrows[idx]],this.collection.cloneMethod)),this.collection.update(obj));return this},Resultset.prototype.remove=function(){return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this},Resultset.prototype.mapReduce=function(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}},Resultset.prototype.eqJoin=function(joinData,leftJoinKey,rightJoinKey,mapFun,dataOptions){var leftData,leftDataLength,rightDataLength,key,rightData=[],result=[],leftKeyisFunction="function"==typeof leftJoinKey,rightKeyisFunction="function"==typeof rightJoinKey,joinMap={};if(leftDataLength=(leftData=this.data(dataOptions)).length,joinData instanceof Collection)rightData=joinData.chain().data(dataOptions);else if(joinData instanceof Resultset)rightData=joinData.data(dataOptions);else{if(!Array.isArray(joinData))throw new TypeError("joinData needs to be an array or result set");rightData=joinData}rightDataLength=rightData.length;for(var i=0;i<rightDataLength;i++)joinMap[key=rightKeyisFunction?rightJoinKey(rightData[i]):rightData[i][rightJoinKey]]=rightData[i];mapFun||(mapFun=function(left,right){return{left:left,right:right}});for(var j=0;j<leftDataLength;j++)key=leftKeyisFunction?leftJoinKey(leftData[j]):leftData[j][leftJoinKey],result.push(mapFun(leftData[j],joinMap[key]||{}));return this.collection=new Collection("joinData"),this.collection.insert(result),this.filteredrows=[],this.filterInitialized=!1,this},Resultset.prototype.map=function(mapFun,dataOptions){var data=this.data(dataOptions).map(mapFun);return this.collection=new Collection("mappedData"),this.collection.insert(data),this.filteredrows=[],this.filterInitialized=!1,this},DynamicView.prototype=new LokiEventEmitter,DynamicView.prototype.constructor=DynamicView,DynamicView.prototype.getSort=function(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple},DynamicView.prototype.rematerialize=function(options){var fpl,fpi,idx;options=options||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new Resultset(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);var wasFrozen=Object.isFrozen(this.filterPipeline);if(options.hasOwnProperty("removeWhereFilters"))for(wasFrozen&&(this.filterPipeline=this.filterPipeline.slice()),fpi=fpl=this.filterPipeline.length;fpi--;)"where"===this.filterPipeline[fpi].type&&(fpi!==this.filterPipeline.length-1&&(this.filterPipeline[fpi]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var ofp=this.filterPipeline;for(this.filterPipeline=[],fpl=ofp.length,idx=0;idx<fpl;idx++)this.applyFind(ofp[idx].val,ofp[idx].uid);return wasFrozen&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this},DynamicView.prototype.branchResultset=function(transform,parameters){var rs=this.resultset.branch();return void 0===transform?rs:rs.transform(transform,parameters)},DynamicView.prototype.toJSON=function(){var copy=new DynamicView(this.collection,this.name,this.options);return copy.resultset=this.resultset,copy.resultdata=[],copy.resultsdirty=!0,copy.filterPipeline=this.filterPipeline,copy.sortFunction=this.sortFunction,copy.sortCriteria=this.sortCriteria,copy.sortCriteriaSimple=this.sortCriteriaSimple||null,copy.sortDirty=this.sortDirty,copy.collection=null,copy},DynamicView.prototype.removeFilters=function(options){options=options||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;var wasFrozen=Object.isFrozen(this.filterPipeline),filterChanged=this.filterPipeline.length>0;this.filterPipeline=[],wasFrozen&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,!0===options.queueSortPhase&&this.queueSortPhase(),filterChanged&&this.emit("filter")},DynamicView.prototype.applySort=function(comparefun){return this.sortFunction=comparefun,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this},DynamicView.prototype.applySimpleSort=function(propname,options){return this.sortCriteriaSimple={propname:propname,options:options||!1},this.collection.disableFreeze||deepFreeze(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},DynamicView.prototype.applySortCriteria=function(criteria){return this.sortCriteria=criteria,this.collection.disableFreeze||deepFreeze(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},DynamicView.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},DynamicView.prototype.commit=function(){return this.cachedresultset=null,this},DynamicView.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},DynamicView.prototype._indexOfFilterWithId=function(uid){if("string"==typeof uid||"number"==typeof uid)for(var idx=0,len=this.filterPipeline.length;idx<len;idx+=1)if(uid===this.filterPipeline[idx].uid)return idx;return-1},DynamicView.prototype._addFilter=function(filter){var wasFrozen=Object.isFrozen(this.filterPipeline);wasFrozen&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||deepFreeze(filter),this.filterPipeline.push(filter),wasFrozen&&Object.freeze(this.filterPipeline),this.resultset[filter.type](filter.val)},DynamicView.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var filters=this.filterPipeline,wasFrozen=Object.isFrozen(filters);this.filterPipeline=[];for(var idx=0,len=filters.length;idx<len;idx+=1)this._addFilter(filters[idx]);return wasFrozen&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},DynamicView.prototype.applyFilter=function(filter){var idx=this._indexOfFilterWithId(filter.uid);if(idx>=0){var wasFrozen=Object.isFrozen(this.filterPipeline);return wasFrozen&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[idx]=filter,wasFrozen&&(freeze(filter),Object.freeze(this.filterPipeline)),this.reapplyFilters()}return this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(filter),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},DynamicView.prototype.applyFind=function(query,uid){return this.applyFilter({type:"find",val:query,uid:uid}),this},DynamicView.prototype.applyWhere=function(fun,uid){return this.applyFilter({type:"where",val:fun,uid:uid}),this},DynamicView.prototype.removeFilter=function(uid){var idx=this._indexOfFilterWithId(uid);if(idx<0)throw new Error("Dynamic view does not contain a filter with ID: "+uid);var wasFrozen=Object.isFrozen(this.filterPipeline);return wasFrozen&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(idx,1),wasFrozen&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this},DynamicView.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},DynamicView.prototype.data=function(options){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(options)},DynamicView.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var self=this;setTimeout((function(){self.rebuildPending&&(self.rebuildPending=!1,self.emit("rebuild",self))}),this.options.minRebuildInterval)}},DynamicView.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var self=this;"active"===this.options.sortPriority?setTimeout((function(){self.performSortPhase()}),this.options.minRebuildInterval):this.queueRebuildEvent()}},DynamicView.prototype.performSortPhase=function(options){(this.sortDirty||this.resultsdirty)&&(options=options||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),options.suppressRebuildEvent||this.emit("rebuild",this))},DynamicView.prototype.evaluateDocument=function(objIndex,isNew){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var filter,ofr=this.resultset.filteredrows,oldPos=isNew?-1:ofr.indexOf(+objIndex),oldlen=ofr.length,evalResultset=new Resultset(this.collection);evalResultset.filteredrows=[objIndex],evalResultset.filterInitialized=!0;for(var idx=0,len=this.filterPipeline.length;idx<len;idx++)evalResultset[(filter=this.filterPipeline[idx]).type](filter.val);var newPos=0===evalResultset.filteredrows.length?-1:0;return-1!==oldPos||-1!==newPos?-1===oldPos&&-1!==newPos?(ofr.push(objIndex),this.options.persistent&&this.resultdata.push(this.collection.data[objIndex]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==oldPos&&-1===newPos?(oldPos<oldlen-1?(ofr.splice(oldPos,1),this.options.persistent&&this.resultdata.splice(oldPos,1)):(ofr.length=oldlen-1,this.options.persistent&&(this.resultdata.length=oldlen-1)),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==oldPos&&-1!==newPos?(this.options.persistent&&(this.resultdata[oldPos]=this.collection.data[objIndex]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},DynamicView.prototype.removeDocument=function(objIndex){var idx,rmidx,rmlen,rxo={},fxo={},adjels=[],drs=this.resultset,fr=this.resultset.filteredrows,frlen=fr.length;if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(Array.isArray(objIndex)||(objIndex=[objIndex]),rmlen=objIndex.length,rmidx=0;rmidx<rmlen;rmidx++)rxo[objIndex[rmidx]]=!0;for(idx=0;idx<frlen;idx++)rxo[fr[idx]]&&(fxo[idx]=!0);Object.keys(fxo).length>0&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((function(di,idx){return!fxo[idx]})),this.options.persistent&&(this.resultdata=this.resultdata.filter((function(obj,idx){return!fxo[idx]}))),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var filt=function(idx){return function(di){return di<drs.filteredrows[idx]}};for(frlen=drs.filteredrows.length,idx=0;idx<frlen;idx++)adjels=objIndex.filter(filt(idx)),drs.filteredrows[idx]-=adjels.length},DynamicView.prototype.mapReduce=function(mapFunction,reduceFunction){try{return reduceFunction(this.data().map(mapFunction))}catch(err){throw err}};class Collection extends LokiEventEmitter{constructor(name,options){super(),this.name=name,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=name,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;const self=this;(options=options||{}).hasOwnProperty("unique")&&(Array.isArray(options.unique)||(options.unique=[options.unique]),options.unique.forEach((prop=>{self.uniqueNames.push(prop)}))),options.hasOwnProperty("exact")&&options.exact.forEach((prop=>{self.constraints.exact[prop]=new ExactIndex(prop)})),this.adaptiveBinaryIndices=!options.hasOwnProperty("adaptiveBinaryIndices")||options.adaptiveBinaryIndices,this.transactional=!!options.hasOwnProperty("transactional")&&options.transactional,this.cloneObjects=!!options.hasOwnProperty("clone")&&options.clone,this.cloneMethod=options.hasOwnProperty("cloneMethod")?options.cloneMethod:"parse-stringify",this.asyncListeners=!!options.hasOwnProperty("asyncListeners")&&options.asyncListeners,this.disableMeta=!!options.hasOwnProperty("disableMeta")&&options.disableMeta,this.disableChangesApi=!options.hasOwnProperty("disableChangesApi")||options.disableChangesApi,this.disableDeltaChangesApi=!options.hasOwnProperty("disableDeltaChangesApi")||options.disableDeltaChangesApi,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=!!options.hasOwnProperty("autoupdate")&&options.autoupdate,this.serializableIndices=!options.hasOwnProperty("serializableIndices")||options.serializableIndices,this.disableFreeze=!options.hasOwnProperty("disableFreeze")||options.disableFreeze,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(options.ttl||-1,options.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[];let indices=[];if(options&&options.indices)if("[object Array]"===Object.prototype.toString.call(options.indices))indices=options.indices;else{if("string"!=typeof options.indices)throw new TypeError("Indices needs to be a string or an array of strings");indices=[options.indices]}for(let idx=0;idx<indices.length;idx++)this.ensureIndex(indices[idx]);function getObjectDelta(oldObject,newObject){const propertyNames=null!==newObject&&"object"==typeof newObject?Object.keys(newObject):null;if(propertyNames&&propertyNames.length&&!["string","boolean","number"].includes(typeof newObject)){const delta={};for(let i=0;i<propertyNames.length;i++){const propertyName=propertyNames[i];if(newObject.hasOwnProperty(propertyName))if(!oldObject.hasOwnProperty(propertyName)||self.uniqueNames.includes(propertyName)||"$loki"==propertyName||"meta"==propertyName)delta[propertyName]=newObject[propertyName];else{const propertyDelta=getObjectDelta(oldObject[propertyName],newObject[propertyName]);void 0!==propertyDelta&&propertyDelta!={}&&(delta[propertyName]=propertyDelta)}}return 0===Object.keys(delta).length?void 0:delta}return oldObject===newObject?void 0:newObject}function flushChanges(){self.changes=[]}this.observerCallback=function(changes){const changedObjects="function"==typeof Set?new Set:[];changedObjects.add||(changedObjects.add=function(object){return this.includes(object)||this.push(object),this}),changes.forEach((({object:object})=>{changedObjects.add(object)})),changedObjects.forEach((object=>{if(!hasOwnProperty.call(object,"$loki"))return self.removeAutoUpdateObserver(object);try{self.update(object)}catch(err){}}))},this.getChangeDelta=function(obj,old){return old?getObjectDelta(old,obj):JSON.parse(JSON.stringify(obj))},this.getObjectDelta=getObjectDelta,this.getChanges=()=>self.changes,this.flushChanges=flushChanges,this.setChangesApi=enabled=>{self.disableChangesApi=!enabled,enabled||(self.disableDeltaChangesApi=!1)},this.on("delete",(function(obj){self.disableChangesApi||self.createChange(self.name,"R",obj)})),this.on("warning",(warning=>{self.lokiConsoleWrapper.warn(warning)})),flushChanges()}createChange(name,op,obj,old){this.changes.push({name:name,operation:op,obj:"U"!=op||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(obj)):this.getChangeDelta(obj,old)})}insertMeta(obj){let len,idx;if(!this.disableMeta&&obj)if(Array.isArray(obj))for(len=obj.length,idx=0;idx<len;idx++)obj[idx].hasOwnProperty("meta")||(obj[idx].meta={}),obj[idx].meta.created=(new Date).getTime(),obj[idx].meta.revision=0;else obj.meta||(obj.meta={}),obj.meta.created=(new Date).getTime(),obj.meta.revision=0}updateMeta(obj){return this.disableMeta||!obj||(this.disableFreeze||((obj=unFreeze(obj)).meta=unFreeze(obj.meta)),obj.meta.updated=(new Date).getTime(),obj.meta.revision+=1),obj}createInsertChange(obj){this.createChange(this.name,"I",obj)}createUpdateChange(obj,old){this.createChange(this.name,"U",obj,old)}insertMetaWithChange(obj){this.insertMeta(obj),this.createInsertChange(obj)}updateMetaWithChange(obj,old,objFrozen){return obj=this.updateMeta(obj,objFrozen),this.createUpdateChange(obj,old),obj}addAutoUpdateObserver(object){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(object,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])}removeAutoUpdateObserver(object){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(object,this.observerCallback)}addTransform(name,transform){if(this.transforms.hasOwnProperty(name))throw new Error("a transform by that name already exists");this.transforms[name]=transform}getTransform(name){return this.transforms[name]}setTransform(name,transform){this.transforms[name]=transform}removeTransform(name){delete this.transforms[name]}byExample(template){let k,obj,query;for(k in query=[],template)template.hasOwnProperty(k)&&query.push((obj={},obj[k]=template[k],obj));return{$and:query}}findObject(template){return this.findOne(this.byExample(template))}findObjects(template){return this.find(this.byExample(template))}ttlDaemonFuncGen(){const collection=this,age=this.ttl.age;return function(){const now=Date.now();collection.chain().where((function(member){const timestamp=member.meta.updated||member.meta.created;return age<now-timestamp})).remove()}}setTTL(age,interval){age<0?clearInterval(this.ttl.daemon):(this.ttl.age=age,this.ttl.ttlInterval=interval,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),interval))}prepareFullDocIndex(){const len=this.data.length,indexes=new Array(len);for(let i=0;i<len;i+=1)indexes[i]=i;return indexes}configureOptions(options={}){options.hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=options.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())}ensureIndex(property,force){if(void 0===force&&(force=!1),null==property)throw new Error("Attempting to set index without an associated property");if(this.binaryIndices[property]&&!force&&!this.binaryIndices[property].dirty)return;if(!0===this.adaptiveBinaryIndices&&this.binaryIndices.hasOwnProperty(property)&&!force)return;const index={name:property,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[property]=index;const wrappedComparer=((prop,data)=>{let val1,val2;const propPath=!!~prop.indexOf(".")&&prop.split(".");return(a,b)=>{if(propPath?(val1=Utils.getIn(data[a],propPath,!0),val2=Utils.getIn(data[b],propPath,!0)):(val1=data[a][prop],val2=data[b][prop]),val1!==val2){if(Comparators.lt(val1,val2,!1))return-1;if(Comparators.gt(val1,val2,!1))return 1}return 0}})(property,this.data);index.values.sort(wrappedComparer),index.dirty=!1,this.dirty=!0}checkAllIndexes(options){let key;const bIndices=this.binaryIndices,results=[];let result;for(key in bIndices)hasOwnProperty.call(bIndices,key)&&(result=this.checkIndex(key,options),result||results.push(key));return results}checkIndex(property,options={}){options.randomSamplingFactor&&!1!==options.randomSampling&&(options.randomSampling=!0),options.randomSamplingFactor=options.randomSamplingFactor||.1,(options.randomSamplingFactor<0||options.randomSamplingFactor>1)&&(options.randomSamplingFactor=.1);let idx,iter,pos,len,biv,valid=!0;if(!this.binaryIndices.hasOwnProperty(property))throw new Error(`called checkIndex on property without an index: ${property}`);if(this.adaptiveBinaryIndices||this.ensureIndex(property),biv=this.binaryIndices[property].values,len=biv.length,len!==this.data.length)return options.repair&&this.ensureIndex(property,!0),!1;if(0===len)return!0;const usingDotNotation=property.includes(".");if(1===len)valid=0===biv[0];else if(options.randomSampling){if(LokiOps.$lte(Utils.getIn(this.data[biv[0]],property,usingDotNotation),Utils.getIn(this.data[biv[1]],property,usingDotNotation))||(valid=!1),LokiOps.$lte(Utils.getIn(this.data[biv[len-2]],property,usingDotNotation),Utils.getIn(this.data[biv[len-1]],property,usingDotNotation))||(valid=!1),valid)for(iter=Math.floor((len-1)*options.randomSamplingFactor),idx=0;idx<iter-1;idx++)if(pos=Math.floor(Math.random()*(len-1)),!LokiOps.$lte(Utils.getIn(this.data[biv[pos]],property,usingDotNotation),Utils.getIn(this.data[biv[pos+1]],property,usingDotNotation))){valid=!1;break}}else for(idx=0;idx<len-1;idx++)if(!LokiOps.$lte(Utils.getIn(this.data[biv[idx]],property,usingDotNotation),Utils.getIn(this.data[biv[idx+1]],property,usingDotNotation))){valid=!1;break}return!valid&&options.repair&&this.ensureIndex(property,!0),valid}getBinaryIndexValues(property){let idx;const idxvals=this.binaryIndices[property].values,result=[];for(idx=0;idx<idxvals.length;idx++)result.push(Utils.getIn(this.data[idxvals[idx]],property,!0));return result}getUniqueIndex(field,force){const index=this.constraints.unique[field];return!index&&force?this.ensureUniqueIndex(field):index}ensureUniqueIndex(field){let index=this.constraints.unique[field];return index||this.uniqueNames.includes(field)||this.uniqueNames.push(field),this.constraints.unique[field]=index=new UniqueIndex(field),this.data.forEach((obj=>{index.set(obj)})),index}ensureAllIndexes(force){let key;const bIndices=this.binaryIndices;for(key in bIndices)hasOwnProperty.call(bIndices,key)&&this.ensureIndex(key,force)}flagBinaryIndexesDirty(){let key;const bIndices=this.binaryIndices;for(key in bIndices)hasOwnProperty.call(bIndices,key)&&(bIndices[key].dirty=!0)}flagBinaryIndexDirty(index){this.binaryIndices[index]&&(this.binaryIndices[index].dirty=!0)}count(query){return query?this.chain().find(query).filteredrows.length:this.data.length}ensureId(){if(this.idIndex)return;const data=this.data;let i=0;const len=data.length,index=new Array(len);for(;i<len;i++)index[i]=data[i].$loki;this.idIndex=index}ensureIdAsync(callback){this.async((function(){this.ensureId()}),callback)}addDynamicView(name,options){const dv=new DynamicView(this,name,options);return this.DynamicViews.push(dv),dv}removeDynamicView(name){this.DynamicViews=this.DynamicViews.filter((dv=>dv.name!==name))}getDynamicView(name){for(let idx=0;idx<this.DynamicViews.length;idx++)if(this.DynamicViews[idx].name===name)return this.DynamicViews[idx];return null}findAndUpdate(filterObject,updateFunction){"function"==typeof filterObject?this.updateWhere(filterObject,updateFunction):this.chain().find(filterObject).update(updateFunction)}findAndRemove(filterObject){this.chain().find(filterObject).remove()}insert(doc,overrideAdaptiveIndices){if(!Array.isArray(doc))return this.insertOne(doc);let obj,results=[];const adaptiveBatchOverride=overrideAdaptiveIndices&&!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;adaptiveBatchOverride&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",doc);for(let i=0,len=doc.length;i<len;i++){if(obj=this.insertOne(doc[i],!0),!obj)return;results.push(obj)}}finally{adaptiveBatchOverride&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",results),results=this.cloneObjects?clone(results,this.cloneMethod):results,1===results.length?results[0]:results}insertOne(doc,bulkInsert){let returnObj,err=null;if("object"!=typeof doc?err=new TypeError("Document needs to be an object"):null===doc&&(err=new TypeError("Object cannot be null")),null!==err)throw this.emit("error",err),err;let obj=this.cloneObjects?clone(doc,this.cloneMethod):doc;if(this.disableFreeze||(obj=unFreeze(obj)),this.disableMeta||(void 0===obj.meta?obj.meta={revision:0,created:0}:this.disableFreeze||(obj.meta=unFreeze(obj.meta))),bulkInsert||this.emit("pre-insert",obj),this.add(obj))return this.disableChangesApi?this.insertMeta(obj):this.insertMetaWithChange(obj),this.disableFreeze||deepFreeze(obj),returnObj=this.cloneObjects?clone(obj,this.cloneMethod):obj,bulkInsert||this.emit("insert",returnObj),this.addAutoUpdateObserver(returnObj),returnObj}clear(options){const self=this;if(options=options||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},!0===options.removeIndices)this.binaryIndices={},this.uniqueNames=[];else{Object.keys(this.binaryIndices).forEach((biname=>{self.binaryIndices[biname].dirty=!1,self.binaryIndices[biname].values=[]}))}}update(doc){let adaptiveBatchOverride,k,len;if(Array.isArray(doc)){len=doc.length,adaptiveBatchOverride=!this.cloneObjects&&this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0,adaptiveBatchOverride&&(this.adaptiveBinaryIndices=!1);try{for(k=0;k<len;k+=1)this.update(doc[k])}finally{adaptiveBatchOverride&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!hasOwnProperty.call(doc,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();const arr=this.get(doc.$loki,!0);let oldInternal,newInternal,position;const self=this;if(!arr)throw new Error("Trying to update a document not in collection.");oldInternal=arr[0],position=arr[1],newInternal=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?clone(doc,this.cloneMethod):doc,this.emit("pre-update",doc),this.uniqueNames.forEach((key=>{self.getUniqueIndex(key,!0).update(oldInternal,newInternal)})),this.data[position]=newInternal,newInternal!==doc&&this.addAutoUpdateObserver(doc);for(let idx=0;idx<this.DynamicViews.length;idx++)this.DynamicViews[idx].evaluateDocument(position,!1);let key,returnObj;if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(key in bIndices)this.adaptiveBinaryIndexUpdate(position,key)}else this.flagBinaryIndexesDirty();return this.idIndex[position]=newInternal.$loki,this.isIncremental&&this.dirtyIds.push(newInternal.$loki),this.commit(),this.dirty=!0,newInternal=this.disableChangesApi?this.updateMeta(newInternal):this.updateMetaWithChange(newInternal,oldInternal),this.disableFreeze||deepFreeze(newInternal),returnObj=this.cloneObjects?clone(newInternal,this.cloneMethod):newInternal,this.emit("update",returnObj,oldInternal),returnObj}catch(err){throw this.rollback(),this.lokiConsoleWrapper.error(err.message),this.emit("error",err),err}}}add(obj){if("object"!=typeof obj)throw new TypeError("Object being added needs to be an object");if(void 0!==obj.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);const newId=this.maxId;obj.$loki=newId,this.disableMeta||(obj.meta.version=0);for(var i=0,len=this.uniqueNames.length;i<len;i++)this.getUniqueIndex(this.uniqueNames[i],!0).set(obj);this.idIndex&&this.idIndex.push(newId),this.isIncremental&&this.dirtyIds.push(newId),this.data.push(obj);const addedPos=this.data.length-1,dvlen=this.DynamicViews.length;for(i=0;i<dvlen;i++)this.DynamicViews[i].evaluateDocument(addedPos,!0);if(this.adaptiveBinaryIndices){const bIndices=this.binaryIndices;for(const key in bIndices)this.adaptiveBinaryIndexInsert(addedPos,key)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?clone(obj,this.cloneMethod):obj}catch(err){throw this.rollback(),this.lokiConsoleWrapper.error(err.message),this.emit("error",err),err}}updateWhere(filterFunction,updateFunction){const results=this.where(filterFunction);let obj,i=0;try{for(;i<results.length;i++)obj=updateFunction(results[i]),this.update(obj)}catch(err){this.rollback(),this.lokiConsoleWrapper.error(err.message)}}removeWhere(query){let list;"function"==typeof query?(list=this.data.filter(query),this.remove(list)):this.chain().find(query).remove()}removeDataOnly(){this.remove(this.data.slice())}removeBatchByPositions(positions){const len=positions.length,xo={};let dlen,didx,idx;const bic=Object.keys(this.binaryIndices).length,uic=Object.keys(this.constraints.unique).length,adaptiveOverride=this.adaptiveBinaryIndices&&Object.keys(this.binaryIndices).length>0;let doc;const self=this;try{for(this.startTransaction(),this.ensureId(),idx=0;idx<len;idx++)xo[this.idIndex[positions[idx]]]=!0;if(dlen=this.DynamicViews.length,dlen>0||bic>0||uic>0){if(dlen>0)for(didx=0;didx<dlen;didx++)this.DynamicViews[didx].removeDocument(positions);if(this.adaptiveBinaryIndices&&!adaptiveOverride){let key;const bIndices=this.binaryIndices;for(key in bIndices)this.adaptiveBinaryIndexRemove(positions,key)}else this.flagBinaryIndexesDirty();uic&&this.uniqueNames.forEach((key=>{const index=self.getUniqueIndex(key);if(index)for(idx=0;idx<len;idx++)doc=self.data[positions[idx]],null!==doc[key]&&void 0!==doc[key]&&index.remove(doc[key])}))}if(!this.disableChangesApi||this.events.delete.length>1)for(idx=0;idx<len;idx++)this.emit("delete",this.data[positions[idx]]);if(this.data=this.data.filter((({$loki:$loki})=>!xo[$loki])),this.isIncremental)for(idx=0;idx<len;idx++)this.dirtyIds.push(this.idIndex[positions[idx]]);this.idIndex=this.idIndex.filter((id=>!xo[id])),this.adaptiveBinaryIndices&&adaptiveOverride&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(err){return this.rollback(),adaptiveOverride&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(err.message),this.emit("error",err),null}}removeBatch(batch){const len=batch.length,dlen=this.data.length;let idx;const xlt={},posx=[];for(idx=0;idx<dlen;idx++)xlt[this.data[idx].$loki]=idx;for(idx=0;idx<len;idx++)"object"==typeof batch[idx]?posx.push(xlt[batch[idx].$loki]):posx.push(xlt[batch[idx]]);this.removeBatchByPositions(posx)}remove(doc){if("number"==typeof doc&&(doc=this.get(doc)),"object"!=typeof doc)throw new Error("Parameter is not an object");if(Array.isArray(doc))this.removeBatch(doc);else{if(!hasOwnProperty.call(doc,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();const arr=this.get(doc.$loki,!0),position=arr[1],self=this;this.uniqueNames.forEach((key=>{if(null!==doc[key]&&void 0!==doc[key]){const index=self.getUniqueIndex(key);index&&index.remove(doc[key])}}));for(let idx=0;idx<this.DynamicViews.length;idx++)this.DynamicViews[idx].removeDocument(position);if(this.adaptiveBinaryIndices){let key;const bIndices=this.binaryIndices;for(key in bIndices)this.adaptiveBinaryIndexRemove(position,key)}else this.flagBinaryIndexesDirty();return this.data.splice(position,1),this.removeAutoUpdateObserver(doc),this.idIndex.splice(position,1),this.isIncremental&&this.dirtyIds.push(doc.$loki),this.commit(),this.dirty=!0,this.emit("delete",arr[0]),this.disableFreeze||(doc=unFreeze(doc)),delete doc.$loki,delete doc.meta,this.disableFreeze||freeze(doc),doc}catch(err){return this.rollback(),this.lokiConsoleWrapper.error(err.message),this.emit("error",err),null}}}get(id,returnPosition){this.idIndex||this.ensureId();const retpos=returnPosition||!1,data=this.idIndex;let max=data.length-1,min=0,mid=min+max>>1;if(id="number"==typeof id?id:parseInt(id,10),isNaN(id))throw new TypeError("Passed id is not an integer");for(;data[min]<data[max];)mid=min+max>>1,data[mid]<id?min=mid+1:max=mid;return max===min&&data[min]===id?retpos?[this.data[min],min]:this.data[min]:null}getBinaryIndexPosition(dataPosition,binaryIndexName){const val=Utils.getIn(this.data[dataPosition],binaryIndexName,!0),index=this.binaryIndices[binaryIndexName].values,range=this.calculateRange("$eq",binaryIndexName,val);if(0===range[0]&&-1===range[1])return null;const min=range[0],max=range[1];for(let idx=min;idx<=max;idx++)if(index[idx]===dataPosition)return idx;return null}adaptiveBinaryIndexInsert(dataPosition,binaryIndexName){const usingDotNotation=binaryIndexName.includes("."),index=this.binaryIndices[binaryIndexName].values;let val=Utils.getIn(this.data[dataPosition],binaryIndexName,usingDotNotation);!0===this.serializableIndices&&val instanceof Date&&(this.data[dataPosition][binaryIndexName]=val.getTime(),val=Utils.getIn(this.data[dataPosition],binaryIndexName));const idxPos=0===index.length?0:this.calculateRangeStart(binaryIndexName,val,!0,usingDotNotation);this.binaryIndices[binaryIndexName].values.splice(idxPos,0,dataPosition)}adaptiveBinaryIndexUpdate(dataPosition,binaryIndexName){let idxPos;const index=this.binaryIndices[binaryIndexName].values,len=index.length;for(idxPos=0;idxPos<len&&index[idxPos]!==dataPosition;idxPos++);this.binaryIndices[binaryIndexName].values.splice(idxPos,1),this.adaptiveBinaryIndexInsert(dataPosition,binaryIndexName)}adaptiveBinaryIndexRemove(dataPosition,binaryIndexName,removedFromIndexOnly){const bi=this.binaryIndices[binaryIndexName];let len,idx,rmidx,rmlen;const rxo={};let curr,shift,idxPos;if(Array.isArray(dataPosition)){if(rmlen=dataPosition.length,1!==rmlen){for(rmidx=0;rmidx<rmlen;rmidx++)rxo[dataPosition[rmidx]]=!0;if(bi.values=bi.values.filter((di=>!rxo[di])),!0===removedFromIndexOnly)return;const sortedPositions=dataPosition.slice();for(sortedPositions.sort(((a,b)=>a-b)),len=bi.values.length,idx=0;idx<len;idx++){for(curr=bi.values[idx],shift=0,rmidx=0;rmidx<rmlen&&curr>sortedPositions[rmidx];rmidx++)shift++;bi.values[idx]-=shift}return}dataPosition=dataPosition[0]}if(idxPos=this.getBinaryIndexPosition(dataPosition,binaryIndexName),null===idxPos)return null;if(bi.values.splice(idxPos,1),!0!==removedFromIndexOnly)for(len=bi.values.length,idx=0;idx<len;idx++)bi.values[idx]>dataPosition&&bi.values[idx]--}calculateRangeStart(prop,val,adaptive,usingDotNotation){const rcd=this.data,index=this.binaryIndices[prop].values;let min=0,max=index.length-1,mid=0;if(0===index.length)return-1;for(;min<max;)mid=min+max>>1,Comparators.lt(Utils.getIn(rcd[index[mid]],prop,usingDotNotation),val,!1)?min=mid+1:max=mid;const lbound=min;return Comparators.aeq(val,Utils.getIn(rcd[index[lbound]],prop,usingDotNotation))?lbound:Comparators.lt(val,Utils.getIn(rcd[index[lbound]],prop,usingDotNotation),!1)?adaptive?lbound:lbound-1:adaptive?lbound+1:lbound}calculateRangeEnd(prop,val,usingDotNotation){const rcd=this.data,index=this.binaryIndices[prop].values;let min=0,max=index.length-1,mid=0;if(0===index.length)return-1;for(;min<max;)mid=min+max>>1,Comparators.lt(val,Utils.getIn(rcd[index[mid]],prop,usingDotNotation),!1)?max=mid:min=mid+1;const ubound=max;return Comparators.aeq(val,Utils.getIn(rcd[index[ubound]],prop,usingDotNotation))?ubound:Comparators.gt(val,Utils.getIn(rcd[index[ubound]],prop,usingDotNotation),!1)?ubound+1:Comparators.aeq(val,Utils.getIn(rcd[index[ubound-1]],prop,usingDotNotation))?ubound-1:ubound}calculateRange(op,prop,val){const rcd=this.data,index=this.binaryIndices[prop].values,max=index.length-1;let lbound,lval,ubound,uval;if(0===rcd.length)return[0,-1];const usingDotNotation=prop.includes("."),minVal=Utils.getIn(rcd[index[0]],prop,usingDotNotation),maxVal=Utils.getIn(rcd[index[max]],prop,usingDotNotation);switch(op){case"$eq":case"$aeq":case"$dteq":if(Comparators.lt(val,minVal,!1)||Comparators.gt(val,maxVal,!1))return[0,-1];break;case"$gt":if(Comparators.gt(val,maxVal,!0))return[0,-1];if(Comparators.gt(minVal,val,!1))return[0,max];break;case"$gte":if(Comparators.gt(val,maxVal,!1))return[0,-1];if(Comparators.gt(minVal,val,!0))return[0,max];break;case"$lt":if(Comparators.lt(val,minVal,!0))return[0,-1];if(Comparators.lt(maxVal,val,!1))return[0,max];break;case"$lte":if(Comparators.lt(val,minVal,!1))return[0,-1];if(Comparators.lt(maxVal,val,!0))return[0,max];break;case"$between":return Comparators.gt(val[0],maxVal,!1)||Comparators.lt(val[1],minVal,!1)?[0,-1]:(lbound=this.calculateRangeStart(prop,val[0],!1,usingDotNotation),ubound=this.calculateRangeEnd(prop,val[1],usingDotNotation),lbound<0&&lbound++,ubound>max&&ubound--,Comparators.gt(Utils.getIn(rcd[index[lbound]],prop,usingDotNotation),val[0],!0)||lbound++,Comparators.lt(Utils.getIn(rcd[index[ubound]],prop,usingDotNotation),val[1],!0)||ubound--,ubound<lbound?[0,-1]:[lbound,ubound]);case"$in":const idxset=[],segResult=[];for(let j=0,len=val.length;j<len;j++){const seg=this.calculateRange("$eq",prop,val[j]);for(let i=seg[0];i<=seg[1];i++)void 0===idxset[i]&&(idxset[i]=!0,segResult.push(i))}return segResult}switch(op){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":lbound=this.calculateRangeStart(prop,val,!1,usingDotNotation),lval=Utils.getIn(rcd[index[lbound]],prop,usingDotNotation)}switch(op){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":ubound=this.calculateRangeEnd(prop,val,usingDotNotation),uval=Utils.getIn(rcd[index[ubound]],prop,usingDotNotation)}switch(op){case"$eq":case"$aeq":case"$dteq":return Comparators.aeq(lval,val)?[lbound,ubound]:[0,-1];case"$gt":return Comparators.aeq(Utils.getIn(rcd[index[ubound]],prop,usingDotNotation),val)?[ubound+1,max]:[ubound,max];case"$gte":return Comparators.aeq(Utils.getIn(rcd[index[lbound]],prop,usingDotNotation),val)?[lbound,max]:[lbound+1,max];case"$lt":return Comparators.aeq(Utils.getIn(rcd[index[lbound]],prop,usingDotNotation),val)?[0,lbound-1]:[0,lbound];case"$lte":return Comparators.aeq(Utils.getIn(rcd[index[ubound]],prop,usingDotNotation),val)?[0,ubound]:[0,ubound-1];default:return[0,rcd.length-1]}}by(field,value){let self;if(void 0===value)return self=this,value=>self.by(field,value);const result=this.getUniqueIndex(field,!0).get(value);return this.cloneObjects?clone(result,this.cloneMethod):result}findOne(query={}){const result=this.chain().find(query,!0).data();return Array.isArray(result)&&0===result.length?null:this.cloneObjects?clone(result[0],this.cloneMethod):result[0]}chain(transform,parameters){const rs=new Resultset(this);return void 0===transform?rs:rs.transform(transform,parameters)}find(query){return this.chain().find(query).data()}findOneUnindexed(prop,value){let doc,i=this.data.length;for(;i--;)if(Utils.getIn(this.data[i],prop,!0)===value)return doc=this.data[i],doc;return null}startTransaction(){if(this.transactional){this.cachedData=clone(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(let idx=0;idx<this.DynamicViews.length;idx++)this.DynamicViews[idx].startTransaction()}}commit(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(let idx=0;idx<this.DynamicViews.length;idx++)this.DynamicViews[idx].commit()}}rollback(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(let idx=0;idx<this.DynamicViews.length;idx++)this.DynamicViews[idx].rollback()}}async(fun,callback){setTimeout((()=>{if("function"!=typeof fun)throw new TypeError("Argument passed for async execution is not a function");fun(),callback()}),0)}where(fun){return this.chain().where(fun).data()}mapReduce(mapFunction,reduceFunction){try{return reduceFunction(this.data.map(mapFunction))}catch(err){throw err}}eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions){return new Resultset(this).eqJoin(joinData,leftJoinProp,rightJoinProp,mapFun,dataOptions)}getStage(name){return this.stages[name]||(this.stages[name]={}),this.stages[name]}stage(stageName,obj){const copy=JSON.parse(JSON.stringify(obj));return this.getStage(stageName)[obj.$loki]=copy,copy}commitStage(stageName,message){const stage=this.getStage(stageName);let prop;const timestamp=(new Date).getTime();for(prop in stage)this.update(stage[prop]),this.commitLog.push({timestamp:timestamp,message:message,data:JSON.parse(JSON.stringify(stage[prop]))});this.stages[stageName]={}}extract(field){let i=0;const len=this.data.length,isDotNotation=isDeepProperty(field),result=[];for(;i<len;i+=1)result.push(deepProperty(this.data[i],field,isDotNotation));return result}max(field){return Math.max.apply(null,this.extract(field))}min(field){return Math.min.apply(null,this.extract(field))}maxRecord(field){let i=0;const len=this.data.length,deep=isDeepProperty(field),result={index:0,value:void 0};let max;for(;i<len;i+=1)void 0!==max?max<deepProperty(this.data[i],field,deep)&&(max=deepProperty(this.data[i],field,deep),result.index=this.data[i].$loki):(max=deepProperty(this.data[i],field,deep),result.index=this.data[i].$loki);return result.value=max,result}minRecord(field){let i=0;const len=this.data.length,deep=isDeepProperty(field),result={index:0,value:void 0};let min;for(;i<len;i+=1)void 0!==min?min>deepProperty(this.data[i],field,deep)&&(min=deepProperty(this.data[i],field,deep),result.index=this.data[i].$loki):(min=deepProperty(this.data[i],field,deep),result.index=this.data[i].$loki);return result.value=min,result}extractNumerical(field){return this.extract(field).map(parseBase10).filter(Number).filter((n=>!isNaN(n)))}avg(field){return average(this.extractNumerical(field))}stdDev(field){return values=this.extractNumerical(field),avg=average(values),avgSquareDiff=average(values.map((function(value){var diff=value-avg;return diff*diff}))),Math.sqrt(avgSquareDiff);var values,avg,avgSquareDiff}mode(field){const dict={},data=this.extract(field);let max,prop,mode;for(prop in data.forEach((obj=>{dict[obj]?dict[obj]+=1:dict[obj]=1})),dict)max?max<dict[prop]&&(mode=prop):(mode=prop,max=dict[prop]);return mode}median(field){const values=this.extractNumerical(field);values.sort(sub);const half=Math.floor(values.length/2);return values.length%2?values[half]:(values[half-1]+values[half])/2}}function isDeepProperty(field){return-1!==field.indexOf(".")}function parseBase10(num){return parseFloat(num,10)}function add(a,b){return a+b}function sub(a,b){return a-b}function average(array){return array.reduce(add,0)/array.length}function deepProperty(obj,property,isDeep){if(!1===isDeep)return obj[property];for(var pieces=property.split("."),root=obj;pieces.length>0;)root=root[pieces.shift()];return root}function binarySearch(array,item,fun){for(var compared,mid,lo=0,hi=array.length;lo<hi;){if(mid=lo+hi>>1,0===(compared=fun.apply(null,[item,array[mid]])))return{found:!0,index:mid};compared<0?hi=mid:lo=mid+1}return{found:!1,index:hi}}function BSonSort(fun){return function(array,item){return binarySearch(array,item,fun)}}function KeyValueStore(){}Collection.prototype.contructor=Collection,Collection.prototype.lokiConsoleWrapper={log(){},warn(){},error(){}},Collection.prototype.stages={},Collection.prototype.commitLog=[],Collection.prototype.no_op=function(){},KeyValueStore.prototype={keys:[],values:[],sort:function(a,b){return a<b?-1:a>b?1:0},setSort:function(fun){this.bs=BSonSort(fun)},bs:function(){return BSonSort(this.sort)},set:function(key,value){var pos=this.bs(this.keys,key);pos.found?this.values[pos.index]=value:(this.keys.splice(pos.index,0,key),this.values.splice(pos.index,0,value))},get:function(key){return this.values[binarySearch(this.keys,key,this.sort).index]}};class UniqueIndex{constructor(uniqueField){this.field=uniqueField,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}set(obj){const fieldValue=obj[this.field];if(null!=fieldValue){if(this.keyMap[fieldValue])throw new Error(`Duplicate key for property ${this.field}: ${fieldValue}`);this.keyMap[fieldValue]=obj,this.lokiMap[obj.$loki]=fieldValue}}get(key){return this.keyMap[key]}byId(id){return this.keyMap[this.lokiMap[id]]}update(obj,doc){if(this.lokiMap[obj.$loki]!==doc[this.field]){const old=this.lokiMap[obj.$loki];this.set(doc),this.keyMap[old]=void 0}else this.keyMap[obj[this.field]]=doc}remove(key){const obj=this.keyMap[key];if(null==obj)throw new Error(`Key is not in unique index: ${this.field}`);this.keyMap[key]=void 0,this.lokiMap[obj.$loki]=void 0}clear(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}}UniqueIndex.prototype.keyMap={},UniqueIndex.prototype.lokiMap={};class ExactIndex{constructor(exactField){this.index=Object.create(null),this.field=exactField}set(key,val){this.index[key]?this.index[key].push(val):this.index[key]=[val]}remove(key,val){const idxSet=this.index[key];for(const i in idxSet)idxSet[i]==val&&idxSet.splice(i,1);idxSet.length<1&&(this.index[key]=void 0)}get(key){return this.index[key]}clear(){this.index={}}}return Loki.deepFreeze=deepFreeze,Loki.freeze=freeze,Loki.unFreeze=unFreeze,Loki.LokiOps=LokiOps,Loki.Collection=Collection,Loki.DynamicView=DynamicView,Loki.Resultset=Resultset,Loki.KeyValueStore=KeyValueStore,Loki.LokiMemoryAdapter=LokiMemoryAdapter,Loki.LokiPartitioningAdapter=LokiPartitioningAdapter,Loki.LokiLocalStorageAdapter=LokiLocalStorageAdapter,Loki.LokiFsAdapter=LokiFsAdapter,Loki.persistenceAdapters={fs:LokiFsAdapter,localStorage:LokiLocalStorageAdapter},Loki.aeq=aeqHelper,Loki.lt=ltHelper,Loki.gt=gtHelper,Loki.Comparators=Comparators,Loki}()}));
